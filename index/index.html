<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>MULTICOLOR SQUARE · Pro Creative Studio</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg-primary:#050816;
            --bg-secondary:#0b1020;
            --bg-tertiary:#111827;
            --stroke-soft:#1f2937;
            --stroke-strong:#4b5563;
            --text-primary:#e5e7eb;
            --text-secondary:#9ca3af;
            --text-muted:#6b7280;
            --accent-1:#6366f1;
            --accent-2:#ec4899;
            --accent-3:#22c55e;
            --accent-4:#06b6d4;
            --shadow-soft:0 18px 45px rgba(15,23,42,.65);
            --shadow-strong:0 22px 60px rgba(15,23,42,.9);
            --radius-sm:8px;
            --radius-md:12px;
            --radius-lg:18px
        }
        @keyframes hueOrbit{0%{filter:hue-rotate(0)}100%{filter:hue-rotate(360deg)}}
        @keyframes floatSoft{0%,100%{transform:translate3d(0,0,0)}40%{transform:translate3d(18px,-22px,0)}70%{transform:translate3d(-18px,18px,0)}}
        @keyframes pulseSoft{0%,100%{box-shadow:0 0 18px rgba(99,102,241,.5),0 0 32px rgba(236,72,153,.25)}50%{box-shadow:0 0 28px rgba(236,72,153,.7),0 0 52px rgba(56,189,248,.55)}}
        @keyframes slideUp{0%{transform:translateY(26px);opacity:0}100%{transform:translateY(0);opacity:1}}
        @keyframes shimmer{0%{background-position:-260px 0}100%{background-position:260px 0}}
        @keyframes rainbowStroke{
            0%{border-color:#f97316;box-shadow:0 0 18px rgba(249,115,22,.65)}
            20%{border-color:#22c55e;box-shadow:0 0 18px rgba(34,197,94,.6)}
            40%{border-color:#06b6d4;box-shadow:0 0 18px rgba(6,182,212,.6)}
            60%{border-color:#6366f1;box-shadow:0 0 18px rgba(99,102,241,.7)}
            80%{border-color:#ec4899;box-shadow:0 0 18px rgba(236,72,153,.75)}
            100%{border-color:#f97316;box-shadow:0 0 18px rgba(249,115,22,.65)}
        }
        body{
            font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",system-ui,sans-serif;
            background:radial-gradient(circle at 0 0,#020617 0,#020617 40%,#020617 100%);
            color:var(--text-primary);
            overflow:hidden
        }
        .bg-orbit{
            position:fixed;inset:0;z-index:0;overflow:hidden;pointer-events:none
        }
        .bg-orbit__layer{
            position:absolute;inset:-20%;
            background:
                radial-gradient(circle at 8% 20%,rgba(56,189,248,.18),transparent 55%),
                radial-gradient(circle at 82% 24%,rgba(236,72,153,.18),transparent 55%),
                radial-gradient(circle at 16% 82%,rgba(34,197,94,.16),transparent 55%),
                radial-gradient(circle at 82% 82%,rgba(129,140,248,.16),transparent 55%);
            animation:hueOrbit 32s linear infinite
        }
        .bg-orbit__blob{
            position:absolute;border-radius:999px;filter:blur(90px);opacity:.55;animation:floatSoft 18s ease-in-out infinite
        }
        .bg-orbit__blob--1{width:420px;height:420px;background:#4f46e5;top:8%;left:6%}
        .bg-orbit__blob--2{width:360px;height:360px;background:#ec4899;bottom:10%;right:8%;animation-delay:2s}
        .bg-orbit__blob--3{width:320px;height:320px;background:#06b6d4;top:48%;left:54%;animation-delay:4s}
        .shell{
            position:relative;z-index:1;height:100vh;display:flex;flex-direction:column
        }
        .shell__header{
            height:64px;
            padding:0 18px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            background:rgba(15,23,42,.9);
            backdrop-filter:blur(26px) saturate(160%);
            -webkit-backdrop-filter:blur(26px) saturate(160%);
            border-bottom:1px solid rgba(31,41,55,.85);
            box-shadow:0 10px 40px rgba(15,23,42,.85);
            animation:slideUp .6s cubic-bezier(.33,1,.68,1)
        }
        .brand{
            display:flex;align-items:center;gap:12px
        }
        .brand__mark{
            width:36px;height:36px;border-radius:11px;
            background:conic-gradient(from 180deg at 50% 50%,#6366f1 0,#ec4899 25%,#22c55e 50%,#06b6d4 75%,#6366f1 100%);
            position:relative;
            box-shadow:0 0 24px rgba(129,140,248,.7);
            animation:pulseSoft 2.6s ease-in-out infinite
        }
        .brand__mark::before{
            content:"";
            position:absolute;inset:0;
            background:linear-gradient(120deg,transparent,rgba(255,255,255,.7),transparent);
            background-size:260px 100%;
            animation:shimmer 2.4s linear infinite;
            mix-blend-mode:screen;opacity:.7
        }
        .brand__title{
            font-size:17px;
            font-weight:800;
            letter-spacing:.09em;
            text-transform:uppercase;
            background:linear-gradient(90deg,#e5e7eb,#c4b5fd,#f9a8d4,#a5b4fc,#e5e7eb);
            background-size:220% 100%;
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            animation:shimmer 7s linear infinite
        }
        .brand__subtitle{
            font-size:11px;
            text-transform:uppercase;
            letter-spacing:.2em;
            color:var(--text-muted)
        }
        .header-actions{
            display:flex;
            align-items:center;
            gap:6px
        }
        .chip-btn{
            position:relative;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            padding:6px 12px;
            border-radius:999px;
            border:1px solid rgba(55,65,81,.9);
            background:radial-gradient(circle at 0 0,rgba(148,163,184,.4),rgba(15,23,42,.95));
            color:var(--text-secondary);
            font-size:11px;
            font-weight:600;
            letter-spacing:.03em;
            cursor:pointer;
            overflow:hidden;
            transition:all .22s cubic-bezier(.33,1,.68,1)
        }
        .chip-btn--primary{
            background:linear-gradient(120deg,rgba(79,70,229,.18),rgba(15,23,42,.9));
            border-color:rgba(129,140,248,.95);
            color:#e5e7eb
        }
        .chip-btn__shine{
            position:absolute;
            inset:-120%;
            background:radial-gradient(circle at 0 0,rgba(248,250,252,.9),transparent 55%);
            transform:translateX(-120%);
            opacity:0;
            transition:all .45s ease-out;
            mix-blend-mode:screen
        }
        .chip-btn:hover .chip-btn__shine{transform:translateX(30%);opacity:.55}
        .chip-btn:hover{
            color:#f9fafb;
            border-color:rgba(196,181,253,.98);
            box-shadow:0 0 20px rgba(129,140,248,.65);
            transform:translateY(-1px) scale(1.02)
        }
        .chip-btn:active{
            transform:translateY(0) scale(.97);
            box-shadow:none
        }
        .chip-btn i{font-size:12px}
        .layout{
            flex:1;
            display:flex;
            overflow:hidden
        }
        .toolbar{
            width:70px;
            padding:10px 0;
            background:rgba(15,23,42,.95);
            border-right:1px solid rgba(31,41,55,.9);
            backdrop-filter:blur(24px) saturate(160%);
            -webkit-backdrop-filter:blur(24px) saturate(160%);
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:6px;
            box-shadow:10px 0 40px rgba(15,23,42,.85);
            z-index:5
        }
        .tool{
            position:relative;
            width:48px;
            height:48px;
            border-radius:14px;
            background:radial-gradient(circle at 0 0,rgba(31,41,55,.85),rgba(15,23,42,.9));
            border:1px solid rgba(31,41,55,.9);
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            transition:all .22s cubic-bezier(.33,1,.68,1);
            overflow:hidden
        }
        .tool__ring{
            position:absolute;
            inset:-1px;
            border-radius:inherit;
            border:1px solid transparent;
            background:conic-gradient(from 150deg,#6366f1,#22c55e,#06b6d4,#eab308,#ec4899,#6366f1);
            opacity:0;
            transition:opacity .22s ease-out;
            mix-blend-mode:screen
        }
        .tool__inner{
            position:relative;
            inset:1px;
            width:100%;
            height:100%;
            border-radius:inherit;
            background:radial-gradient(circle at 0 0,rgba(31,41,55,.9),rgba(15,23,42,.95));
            display:flex;
            align-items:center;
            justify-content:center
        }
        .tool i{
            font-size:17px;
            color:var(--text-muted);
            transition:transform .18s ease-out,color .18s ease-out
        }
        .tool:hover{
            transform:translateY(-2px) scale(1.08);
            box-shadow:0 14px 26px rgba(15,23,42,.9)
        }
        .tool:hover i{color:#e5e7eb;transform:scale(1.05)}
        .tool:hover .tool__ring{opacity:.7}
        .tool--active{
            background:radial-gradient(circle at 0 0,rgba(37,99,235,.18),rgba(15,23,42,.98));
            border-color:rgba(129,140,248,.9);
            box-shadow:0 0 28px rgba(129,140,248,.9);
            animation:pulseSoft 2.4s ease-in-out infinite
        }
        .tool--active i{color:#e5e7eb}
        .tool--active .tool__ring{opacity:1}
        .tool-tip{
            position:absolute;
            left:62px;
            padding:4px 9px;
            border-radius:999px;
            border:1px solid rgba(55,65,81,.9);
            background:radial-gradient(circle at 0 0,rgba(51,65,85,.9),rgba(15,23,42,.98));
            color:var(--text-secondary);
            font-size:10px;
            white-space:nowrap;
            letter-spacing:.03em;
            transform:translateX(-6px);
            opacity:0;
            pointer-events:none;
            transition:all .2s ease-out;
            box-shadow:0 10px 26px rgba(15,23,42,.9)
        }
        .tool:hover .tool-tip{transform:translateX(0);opacity:1}
        .panel{
            width:280px;
            padding:14px 14px 16px;
            background:rgba(15,23,42,.94);
            border-right:1px solid rgba(31,41,55,.95);
            backdrop-filter:blur(26px) saturate(170%);
            -webkit-backdrop-filter:blur(26px) saturate(170%);
            box-shadow:12px 0 42px rgba(15,23,42,.9);
            overflow-y:auto
        }
        .panel__group{margin-bottom:16px}
        .panel__label{
            font-size:10px;
            text-transform:uppercase;
            letter-spacing:.16em;
            color:var(--text-muted);
            margin-bottom:7px
        }
        .range-row{
            display:flex;
            align-items:center;
            gap:10px
        }
        .range{
            flex:1;
            -webkit-appearance:none;
            height:5px;
            border-radius:999px;
            background:linear-gradient(90deg,rgba(31,41,55,.9),rgba(55,65,81,.95));
            outline:none;
            cursor:pointer
        }
        .range::-webkit-slider-thumb{
            -webkit-appearance:none;
            width:16px;
            height:16px;
            border-radius:999px;
            background:conic-gradient(from 180deg,#6366f1,#ec4899,#22c55e,#06b6d4,#6366f1);
            box-shadow:0 0 12px rgba(129,140,248,.9);
            border:none;
            transition:transform .18s ease-out,box-shadow .18s ease-out
        }
        .range::-webkit-slider-thumb:hover{
            transform:scale(1.35);
            box-shadow:0 0 24px rgba(129,140,248,1)
        }
        .range-value{
            min-width:46px;
            padding:3px 8px;
            border-radius:999px;
            border:1px solid rgba(55,65,81,.95);
            background:radial-gradient(circle at 0 0,rgba(31,41,55,.95),rgba(15,23,42,.98));
            font-size:11px;
            text-align:center;
            color:#e5e7eb
        }
        .pill-toggle{
            width:46px;
            height:24px;
            border-radius:999px;
            border:1px solid rgba(55,65,81,.9);
            background:radial-gradient(circle at 0 0,rgba(31,41,55,.95),rgba(15,23,42,.98));
            padding:2px;
            display:flex;
            align-items:center;
            cursor:pointer;
            transition:all .22s cubic-bezier(.33,1,.68,1)
        }
        .pill-toggle__dot{
            width:18px;
            height:18px;
            border-radius:999px;
            background:#e5e7eb;
            box-shadow:0 0 12px rgba(148,163,184,.9);
            transform:translateX(0);
            transition:transform .22s cubic-bezier(.33,1,.68,1),box-shadow .22s
        }
        .pill-toggle--on{
            border-color:transparent;
            background:conic-gradient(from 220deg,#22c55e,#22c55e,#06b6d4,#6366f1,#ec4899,#22c55e)
        }
        .pill-toggle--on .pill-toggle__dot{
            transform:translateX(20px);
            box-shadow:0 0 18px rgba(34,197,94,1)
        }
        .select{
            width:100%;
            border-radius:999px;
            border:1px solid rgba(55,65,81,.9);
            background:radial-gradient(circle at 0 0,rgba(31,41,55,.95),rgba(15,23,42,.98));
            padding:7px 10px;
            font-size:12px;
            color:var(--text-secondary);
            outline:none;
            cursor:pointer
        }
        .palette{
            display:grid;
            grid-template-columns:repeat(6,1fr);
            gap:6px
        }
        .swatch{
            position:relative;
            aspect-ratio:1/1;
            border-radius:8px;
            border:1px solid rgba(31,41,55,.9);
            cursor:pointer;
            overflow:hidden;
            transition:transform .18s ease-out,box-shadow .18s ease-out,border-color .18s ease-out
        }
        .swatch::after{
            content:"";
            position:absolute;
            inset:-1px;
            border-radius:inherit;
            border:1px solid transparent;
            background:conic-gradient(from 140deg,#6366f1,#22c55e,#06b6d4,#eab308,#ec4899,#6366f1);
            opacity:0;
            mix-blend-mode:screen;
            transition:opacity .18s ease-out
        }
        .swatch:hover{
            transform:translateY(-2px) scale(1.1);
            box-shadow:0 10px 24px rgba(15,23,42,.9)
        }
        .swatch:hover::after{opacity:.9}
        .swatch--active{border-color:#e5e7eb;transform:scale(1.06)}
        .swatch--active::after{opacity:1}
        .canvas-shell{
            flex:1;
            display:flex;
            flex-direction:column;
            background:radial-gradient(circle at 50% 0,rgba(15,23,42,.9),#020617 55%,#020617 100%)
        }
        .canvas-zone{
            flex:1;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:18px;
            overflow:auto
        }
        .canvas-frame{
            position:relative;
            border-radius:16px;
            border:1px solid rgba(55,65,81,.9);
            background:radial-gradient(circle at 0 0,#020617,#020617 60%,#020617 100%);
            box-shadow:var(--shadow-strong);
            transition:box-shadow .3s ease-out,transform .3s ease-out
        }
        .canvas-frame--rainbow{
            animation:rainbowStroke 3.4s linear infinite
        }
        .canvas-main,
        .canvas-preview{
            border-radius:14px;
            display:block;
            background:#f9fafb
        }
        .canvas-preview{
            position:absolute;
            inset:0;
            pointer-events:none
        }
        .dock{
            height:70px;
            padding:0 18px;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:10px;
            background:rgba(15,23,42,.96);
            border-top:1px solid rgba(31,41,55,.95);
            box-shadow:0 -10px 40px rgba(15,23,42,.95);
            backdrop-filter:blur(22px) saturate(160%);
            -webkit-backdrop-filter:blur(22px) saturate(160%)
        }
        .dock-btn{
            position:relative;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            padding:7px 14px;
            border-radius:999px;
            border:1px solid rgba(55,65,81,.95);
            background:radial-gradient(circle at 0 0,rgba(31,41,55,.9),rgba(15,23,42,.98));
            color:var(--text-secondary);
            font-size:11px;
            font-weight:600;
            cursor:pointer;
            transition:all .2s ease-out
        }
        .dock-btn--primary{
            background:linear-gradient(120deg,#6366f1,#ec4899);
            border:none;
            color:#f9fafb;
            box-shadow:0 14px 32px rgba(79,70,229,.8)
        }
        .dock-btn:hover{
            transform:translateY(-1px) scale(1.02);
            box-shadow:0 10px 28px rgba(15,23,42,.9)
        }
        .dock-btn--primary:hover{
            box-shadow:0 18px 40px rgba(79,70,229,.9)
        }
        .dock-btn:active{transform:translateY(0) scale(.97);box-shadow:none}
        .zoom{
            display:flex;
            align-items:center;
            gap:6px;
            margin:0 12px
        }
        .zoom__btn{
            width:32px;
            height:32px;
            border-radius:999px;
            border:1px solid rgba(55,65,81,.95);
            background:radial-gradient(circle at 0 0,rgba(31,41,55,.95),rgba(15,23,42,.98));
            color:var(--text-muted);
            font-size:12px;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:all .18s ease-out
        }
        .zoom__btn:hover{
            color:#e5e7eb;
            border-color:rgba(129,140,248,.98);
            box-shadow:0 10px 26px rgba(15,23,42,.9);
            transform:translateY(-1px) scale(1.06)
        }
        .zoom__value{
            min-width:54px;
            padding:5px 10px;
            border-radius:999px;
            border:1px solid rgba(55,65,81,.95);
            background:radial-gradient(circle at 0 0,rgba(31,41,55,.95),rgba(15,23,42,.98));
            font-size:11px;
            color:#e5e7eb;
            text-align:center
        }
        .share-fab{
            position:fixed;
            right:18px;
            bottom:18px;
            z-index:40
        }
        .share-fab__btn{
            width:46px;
            height:46px;
            border-radius:999px;
            border:none;
            background:conic-gradient(from 160deg,#6366f1,#22c55e,#06b6d4,#eab308,#ec4899,#6366f1);
            display:flex;
            align-items:center;
            justify-content:center;
            color:#f9fafb;
            box-shadow:0 18px 40px rgba(15,23,42,.95);
            cursor:pointer;
            position:relative;
            overflow:hidden;
            animation:pulseSoft 2.4s ease-in-out infinite
        }
        .share-fab__ripple{
            position:absolute;
            width:10px;
            height:10px;
            border-radius:999px;
            border:2px solid rgba(248,250,252,.8);
            opacity:0;
            pointer-events:none
        }
        .share-fab__icon{position:relative;z-index:1;font-size:16px}
        .share-menu{
            position:absolute;
            right:0;
            bottom:56px;
            padding:8px;
            border-radius:16px;
            border:1px solid rgba(55,65,81,.95);
            background:radial-gradient(circle at 0 0,rgba(31,41,55,.98),rgba(15,23,42,.99));
            box-shadow:0 24px 50px rgba(15,23,42,.95);
            display:none;
            flex-direction:column;
            gap:6px;
            animation:slideUp .25s ease-out
        }
        .share-menu--open{display:flex}
        .share-icon{
            width:40px;
            height:40px;
            border-radius:12px;
            border:none;
            display:flex;
            align-items:center;
            justify-content:center;
            color:#f9fafb;
            cursor:pointer;
            font-size:18px;
            transition:transform .18s ease-out,box-shadow .18s ease-out
        }
        .share-icon:hover{transform:translateY(-2px) scale(1.08);box-shadow:0 10px 26px rgba(15,23,42,.95)}
        .share-icon--tg{background:linear-gradient(135deg,#0ea5e9,#22c1f1)}
        .share-icon--vk{background:linear-gradient(135deg,#2563eb,#1d4ed8)}
        .share-icon--pin{background:linear-gradient(135deg,#ef4444,#b91c1c)}
        .share-icon--wa{background:linear-gradient(135deg,#22c55e,#16a34a)}
        .share-icon--x{background:linear-gradient(135deg,#0f172a,#334155)}
        .modal{
            position:fixed;
            inset:0;
            display:none;
            align-items:center;
            justify-content:center;
            background:rgba(15,23,42,.86);
            backdrop-filter:blur(22px);
            -webkit-backdrop-filter:blur(22px);
            z-index:50
        }
        .modal--open{display:flex}
        .modal__card{
            max-width:480px;
            width:90%;
            border-radius:20px;
            padding:20px 18px 18px;
            border:1px solid rgba(55,65,81,.95);
            background:radial-gradient(circle at 0 0,rgba(31,41,55,.98),rgba(15,23,42,.99));
            box-shadow:0 26px 70px rgba(15,23,42,1);
            animation:slideUp .28s ease-out
        }
        .modal__title{
            font-size:16px;
            font-weight:700;
            letter-spacing:.08em;
            text-transform:uppercase;
            margin-bottom:14px;
            background:linear-gradient(90deg,#e5e7eb,#a5b4fc,#f9a8d4);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent
        }
        .modal__grid{
            display:grid;
            grid-template-columns:repeat(2,minmax(0,1fr));
            gap:8px
        }
        .modal__btn{
            padding:8px 10px;
            border-radius:12px;
            border:1px solid rgba(55,65,81,.95);
            background:radial-gradient(circle at 0 0,rgba(31,41,55,.96),rgba(15,23,42,.99));
            color:var(--text-secondary);
            font-size:12px;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:space-between;
            transition:all .2s ease-out
        }
        .modal__btn span{font-weight:600}
        .modal__btn:hover{
            border-color:rgba(129,140,248,.98);
            color:#e5e7eb;
            box-shadow:0 10px 26px rgba(15,23,42,.95);
            transform:translateY(-1px) scale(1.02)
        }
        .modal__actions{
            margin-top:16px;
            display:flex;
            justify-content:flex-end;
            gap:8px
        }
        .modal__close{
            border-radius:999px;
            padding:6px 12px;
            border:1px solid rgba(55,65,81,.95);
            background:transparent;
            color:var(--text-secondary);
            font-size:11px;
            cursor:pointer
        }
        .modal__primary{
            border-radius:999px;
            padding:6px 14px;
            border:none;
            background:linear-gradient(120deg,#6366f1,#ec4899);
            color:#f9fafb;
            font-size:11px;
            font-weight:600;
            cursor:pointer;
            box-shadow:0 14px 30px rgba(79,70,229,.9)
        }
        .layers-panel{
            position:fixed;
            right:-260px;
            top:64px;
            width:250px;
            height:calc(100vh - 64px);
            padding:14px 14px 16px;
            background:radial-gradient(circle at 0 0,rgba(31,41,55,.98),rgba(15,23,42,.99));
            border-left:1px solid rgba(55,65,81,.95);
            box-shadow:-16px 0 40px rgba(15,23,42,1);
            backdrop-filter:blur(24px);
            -webkit-backdrop-filter:blur(24px);
            transition:right .28s cubic-bezier(.33,1,.68,1);
            z-index:35
        }
        .layers-panel--open{right:0}
        .layers-panel__header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            margin-bottom:10px
        }
        .layers-panel__title{
            font-size:13px;
            letter-spacing:.14em;
            text-transform:uppercase;
            color:var(--text-muted)
        }
        .layers-panel__add{
            width:24px;
            height:24px;
            border-radius:999px;
            border:1px solid rgba(55,65,81,.95);
            background:radial-gradient(circle at 0 0,rgba(31,41,55,.96),rgba(15,23,42,.99));
            color:var(--text-secondary);
            font-size:12px;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center
        }
        .layers-list{
            max-height:calc(100vh - 120px);
            overflow-y:auto;
            display:flex;
            flex-direction:column;
            gap:6px
        }
        .layer-item{
            display:flex;
            align-items:center;
            gap:8px;
            padding:6px 6px;
            border-radius:999px;
            border:1px solid rgba(55,65,81,.95);
            background:radial-gradient(circle at 0 0,rgba(31,41,55,.96),rgba(15,23,42,.99));
            cursor:pointer;
            transition:all .18s ease-out
        }
        .layer-item--active{
            border-color:rgba(129,140,248,.98);
            box-shadow:0 0 18px rgba(129,140,248,.9)
        }
        .layer-item__preview{
            width:30px;height:24px;border-radius:999px;border:1px solid rgba(55,65,81,.95);overflow:hidden;background:#f9fafb
        }
        .layer-item__name{
            flex:1;
            font-size:11px;
            color:var(--text-secondary)
        }
        .layer-item__icons{
            display:flex;gap:4px;font-size:11px;color:var(--text-muted)
        }
        ::-webkit-scrollbar{width:8px;height:8px}
        ::-webkit-scrollbar-track{background:rgba(15,23,42,.9)}
        ::-webkit-scrollbar-thumb{border-radius:999px;background:linear-gradient(180deg,#4b5563,#1f2937)}
        ::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,#6b7280,#374151)}
    </style>
</head>
<body>
<div class="bg-orbit">
    <div class="bg-orbit__layer"></div>
    <div class="bg-orbit__blob bg-orbit__blob--1"></div>
    <div class="bg-orbit__blob bg-orbit__blob--2"></div>
    <div class="bg-orbit__blob bg-orbit__blob--3"></div>
</div>

<div class="shell">
    <header class="shell__header">
        <div class="brand">
            <div class="brand__mark"></div>
            <div>
                <div class="brand__title">MULTICOLOR SQUARE</div>
                <div class="brand__subtitle">CREATIVE PIXEL STUDIO</div>
            </div>
        </div>
        <div class="header-actions">
            <button class="chip-btn" id="btn-new">
                <span>Новый</span>
                <i class="fa-regular fa-file"></i>
                <span class="chip-btn__shine"></span>
            </button>
            <button class="chip-btn" id="btn-open">
                <span>Открыть</span><i class="fa-regular fa-folder-open"></i><span class="chip-btn__shine"></span>
            </button>
            <button class="chip-btn" id="btn-save">
                <span>Сохранить</span><i class="fa-regular fa-floppy-disk"></i><span class="chip-btn__shine"></span>
            </button>
            <button class="chip-btn" id="btn-export">
                <span>Экспорт</span><i class="fa-solid fa-download"></i><span class="chip-btn__shine"></span>
            </button>
            <button class="chip-btn" id="btn-effects">
                <span>Эффекты</span><i class="fa-solid fa-wand-magic-sparkles"></i><span class="chip-btn__shine"></span>
            </button>
            <button class="chip-btn chip-btn--primary" id="btn-canvas">
                <span>Холст</span><i class="fa-solid fa-expand"></i><span class="chip-btn__shine"></span>
            </button>
            <button class="chip-btn" id="btn-layers">
                <span>Слои</span><i class="fa-solid fa-layer-group"></i><span class="chip-btn__shine"></span>
            </button>
        </div>
    </header>

    <main class="layout">
        <aside class="toolbar">
            <button class="tool tool--active" data-tool="brush">
                <span class="tool__ring"></span>
                <span class="tool__inner"><i class="fa-solid fa-paintbrush"></i></span>
                <span class="tool-tip">Кисть · B</span>
            </button>
            <button class="tool" data-tool="eraser">
                <span class="tool__ring"></span>
                <span class="tool__inner"><i class="fa-solid fa-eraser"></i></span>
                <span class="tool-tip">Ластик · E</span>
            </button>
            <button class="tool" data-tool="fill">
                <span class="tool__ring"></span>
                <span class="tool__inner"><i class="fa-solid fa-fill-drip"></i></span>
                <span class="tool-tip">Заливка · G</span>
            </button>
            <button class="tool" data-tool="gradient">
                <span class="tool__ring"></span>
                <span class="tool__inner"><i class="fa-solid fa-fill"></i></span>
                <span class="tool-tip">Градиент · D</span>
            </button>
            <button class="tool" data-tool="picker">
                <span class="tool__ring"></span>
                <span class="tool__inner"><i class="fa-solid fa-eye-dropper"></i></span>
                <span class="tool-tip">Пипетка · I</span>
            </button>
            <button class="tool" data-tool="spray">
                <span class="tool__ring"></span>
                <span class="tool__inner"><i class="fa-solid fa-spray-can-sparkles"></i></span>
                <span class="tool-tip">Аэрограф · S</span>
            </button>
            <button class="tool" data-tool="blur">
                <span class="tool__ring"></span>
                <span class="tool__inner"><i class="fa-solid fa-droplet"></i></span>
                <span class="tool-tip">Размытие</span>
            </button>
            <button class="tool" data-tool="smudge">
                <span class="tool__ring"></span>
                <span class="tool__inner"><i class="fa-regular fa-hand"></i></span>
                <span class="tool-tip">Палец</span>
            </button>
            <button class="tool" data-tool="line">
                <span class="tool__ring"></span>
                <span class="tool__inner"><i class="fa-solid fa-grip-lines"></i></span>
                <span class="tool-tip">Линия · L</span>
            </button>
            <button class="tool" data-tool="rect">
                <span class="tool__ring"></span>
                <span class="tool__inner"><i class="fa-regular fa-square"></i></span>
                <span class="tool-tip">Прямоуг.</span>
            </button>
            <button class="tool" data-tool="circle">
                <span class="tool__ring"></span>
                <span class="tool__inner"><i class="fa-regular fa-circle"></i></span>
                <span class="tool-tip">Круг</span>
            </button>
            <button class="tool" data-tool="poly">
                <span class="tool__ring"></span>
                <span class="tool__inner"><i class="fa-solid fa-draw-polygon"></i></span>
                <span class="tool-tip">Многоугольник</span>
            </button>
            <button class="tool" data-tool="text">
                <span class="tool__ring"></span>
                <span class="tool__inner"><i class="fa-solid fa-font"></i></span>
                <span class="tool-tip">Текст · T</span>
            </button>
        </aside>

        <aside class="panel">
            <div class="panel__group">
                <div class="panel__label">Размер кисти</div>
                <div class="range-row">
                    <input id="range-size" type="range" min="1" max="120" value="6" class="range" />
                    <div id="val-size" class="range-value">6 px</div>
                </div>
            </div>
            <div class="panel__group">
                <div class="panel__label">Прозрачность</div>
                <div class="range-row">
                    <input id="range-opacity" type="range" min="0" max="100" value="100" class="range" />
                    <div id="val-opacity" class="range-value">100%</div>
                </div>
            </div>
            <div class="panel__group">
                <div class="panel__label">Твердость</div>
                <div class="range-row">
                    <input id="range-hardness" type="range" min="0" max="100" value="100" class="range" />
                    <div id="val-hardness" class="range-value">100%</div>
                </div>
            </div>
            <div class="panel__group">
                <div class="panel__label">Радужный режим</div>
                <div id="toggle-rainbow" class="pill-toggle">
                    <div class="pill-toggle__dot"></div>
                </div>
            </div>
            <div class="panel__group">
                <div class="panel__label">Режим наложения</div>
                <select id="blend-mode" class="select">
                    <option value="source-over">Normal</option>
                    <option value="multiply">Multiply</option>
                    <option value="screen">Screen</option>
                    <option value="overlay">Overlay</option>
                    <option value="darken">Darken</option>
                    <option value="lighten">Lighten</option>
                    <option value="color-dodge">Color Dodge</option>
                    <option value="color-burn">Color Burn</option>
                    <option value="hard-light">Hard Light</option>
                    <option value="soft-light">Soft Light</option>
                    <option value="difference">Difference</option>
                    <option value="exclusion">Exclusion</option>
                </select>
            </div>
            <div class="panel__group">
                <div class="panel__label">Цвета</div>
                <div class="range-row" style="gap:8px">
                    <div id="primary-swatch" class="swatch" style="flex:1;background:#000"></div>
                    <div id="secondary-swatch" class="swatch" style="flex:1;background:#fff"></div>
                    <input id="primary-color" type="color" value="#000000" hidden />
                    <input id="secondary-color" type="color" value="#ffffff" hidden />
                </div>
            </div>
            <div class="panel__group">
                <div class="panel__label">Палитра</div>
                <div id="palette" class="palette"></div>
            </div>
        </aside>

        <section class="canvas-shell">
            <div class="canvas-zone">
                <div id="canvas-frame" class="canvas-frame">
                    <canvas id="canvas" class="canvas-main" width="960" height="620"></canvas>
                    <canvas id="canvas-preview" class="canvas-preview" width="960" height="620"></canvas>
                </div>
            </div>
            <footer class="dock">
                <button id="btn-undo" class="dock-btn"><i class="fa-solid fa-rotate-left"></i><span>Отменить</span></button>
                <button id="btn-redo" class="dock-btn"><i class="fa-solid fa-rotate-right"></i><span>Вернуть</span></button>
                <div class="zoom">
                    <button id="zoom-out" class="zoom__btn"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
                    <div id="zoom-label" class="zoom__value">100%</div>
                    <button id="zoom-in" class="zoom__btn"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
                    <button id="zoom-reset" class="zoom__btn"><i class="fa-solid fa-compress"></i></button>
                </div>
                <button id="btn-flip-h" class="dock-btn"><i class="fa-solid fa-arrows-left-right"></i><span>Отразить H</span></button>
                <button id="btn-flip-v" class="dock-btn"><i class="fa-solid fa-arrows-up-down"></i><span>Отразить V</span></button>
                <button id="btn-rotate" class="dock-btn"><i class="fa-solid fa-rotate"></i><span>Повернуть 90°</span></button>
                <button id="btn-clear" class="dock-btn dock-btn--primary"><i class="fa-solid fa-trash"></i><span>Очистить</span></button>
            </footer>
        </section>
    </main>
</div>

<div class="share-fab">
    <button id="share-main" class="share-fab__btn">
        <span class="share-fab__icon"><i class="fa-solid fa-share-nodes"></i></span>
        <span id="share-ripple" class="share-fab__ripple"></span>
    </button>
    <div id="share-menu" class="share-menu">
        <button class="share-icon share-icon--tg" data-platform="telegram"><i class="fa-brands fa-telegram"></i></button>
        <button class="share-icon share-icon--vk" data-platform="vk"><i class="fa-brands fa-vk"></i></button>
        <button class="share-icon share-icon--pin" data-platform="pinterest"><i class="fa-brands fa-pinterest-p"></i></button>
        <button class="share-icon share-icon--wa" data-platform="whatsapp"><i class="fa-brands fa-whatsapp"></i></button>
        <button class="share-icon share-icon--x" data-platform="twitter"></button>
    </div>
</div>

<div id="modal-canvas" class="modal">
    <div class="modal__card">
        <div class="modal__title">Размер холста</div>
        <div class="panel__group">
            <div class="panel__label">Пресеты</div>
            <div class="modal__grid">
                <button class="modal__btn" data-w="800" data-h="600"><span>800×600</span><span>4:3</span></button>
                <button class="modal__btn" data-w="1024" data-h="768"><span>1024×768</span><span>4:3</span></button>
                <button class="modal__btn" data-w="1280" data-h="720"><span>1280×720</span><span>HD</span></button>
                <button class="modal__btn" data-w="1920" data-h="1080"><span>1920×1080</span><span>Full HD</span></button>
            </div>
        </div>
        <div class="panel__group">
            <div class="panel__label">Свои значения</div>
            <div class="range-row">
                <input id="custom-w" type="number" min="1" max="4096" value="960" class="select" style="max-width:110px" />
                <span style="font-size:11px;color:var(--text-muted)">×</span>
                <input id="custom-h" type="number" min="1" max="4096" value="620" class="select" style="max-width:110px" />
            </div>
        </div>
        <div class="modal__actions">
            <button id="canvas-cancel" class="modal__close">Отмена</button>
            <button id="canvas-apply" class="modal__primary">Применить</button>
        </div>
    </div>
</div>

<div id="modal-export" class="modal">
    <div class="modal__card">
        <div class="modal__title">Экспорт</div>
        <div class="panel__group">
            <div class="panel__label">Формат</div>
            <select id="export-format" class="select">
                <option value="png">PNG</option>
                <option value="jpeg">JPEG</option>
                <option value="webp">WebP</option>
            </select>
        </div>
        <div class="panel__group">
            <div class="panel__label">Качество</div>
            <div class="range-row">
                <input id="range-quality" type="range" min="50" max="100" value="95" class="range" />
                <div id="val-quality" class="range-value">95%</div>
            </div>
        </div>
        <div class="modal__actions">
            <button id="export-cancel" class="modal__close">Отмена</button>
            <button id="export-ok" class="modal__primary">Скачать</button>
        </div>
    </div>
</div>

<div id="layers-panel" class="layers-panel">
    <div class="layers-panel__header">
        <div class="layers-panel__title">SLAYERS</div>
        <button id="add-layer" class="layers-panel__add"><i class="fa-solid fa-plus"></i></button>
    </div>
    <div id="layers-list" class="layers-list"></div>
</div>

<script>
(() => {
    const canvas = document.getElementById("canvas");
    const previewCanvas = document.getElementById("canvas-preview");
    const ctx = canvas.getContext("2d",{willReadFrequently:true});
    const pCtx = previewCanvas.getContext("2d");
    const frame = document.getElementById("canvas-frame");
    const shareBtn = document.getElementById("share-main");
    const shareMenu = document.getElementById("share-menu");
    const shareRipple = document.getElementById("share-ripple");
    const zoomLabel = document.getElementById("zoom-label");
    const rangeSize = document.getElementById("range-size");
    const rangeOp = document.getElementById("range-opacity");
    const rangeHard = document.getElementById("range-hardness");
    const valSize = document.getElementById("val-size");
    const valOp = document.getElementById("val-opacity");
    const valHard = document.getElementById("val-hardness");
    const toggleRainbow = document.getElementById("toggle-rainbow");
    const primarySwatch = document.getElementById("primary-swatch");
    const secondarySwatch = document.getElementById("secondary-swatch");
    const primaryColorInput = document.getElementById("primary-color");
    const secondaryColorInput = document.getElementById("secondary-color");
    const blendModeSelect = document.getElementById("blend-mode");
    const paletteEl = document.getElementById("palette");
    const layersPanel = document.getElementById("layers-panel");
    const layersList = document.getElementById("layers-list");

    const state = {
        tool:"brush",
        size:6,
        opacity:1,
        hardness:1,
        rainbow:false,
        colorPrimary:"#000000",
        colorSecondary:"#ffffff",
        zoom:1,
        blend:"source-over",
        layers:[],
        currentLayer:0,
        history:[],
        historyIndex:-1,
        maxHistory:80,
        drawing:false,
        lastX:0,lastY:0
    };

    function initBase(){
        addLayer("Фон",true);
        ctx.fillStyle="#ffffff";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        renderLayers();
        pushHistory();
    }

    function addLayer(name,select=false){
        const off = document.createElement("canvas");
        off.width = canvas.width;
        off.height = canvas.height;
        const lctx = off.getContext("2d");
        lctx.clearRect(0,0,off.width,off.height);
        state.layers.push({name,canvas:off,visible:true,locked:false});
        if(select) state.currentLayer = state.layers.length-1;
        rebuildLayersUI();
    }

    function rebuildLayersUI(){
        layersList.innerHTML="";
        const total = state.layers.length;
        for(let i=total-1;i>=0;i--){
            const layer = state.layers[i];
            const item = document.createElement("button");
            item.className="layer-item"+(i===state.currentLayer?" layer-item--active":"");
            item.dataset.index=String(i);

            const prev = document.createElement("canvas");
            prev.className="layer-item__preview";
            prev.width=60;prev.height=24;
            const pctx=prev.getContext("2d");
            pctx.fillStyle="#f9fafb";
            pctx.fillRect(0,0,prev.width,prev.height);
            pctx.drawImage(layer.canvas,0,0,prev.width,prev.height);

            const name = document.createElement("div");
            name.className="layer-item__name";
            name.textContent = layer.name;

            const icons = document.createElement("div");
            icons.className="layer-item__icons";
            icons.innerHTML = layer.visible?'<i class="fa-regular fa-eye"></i>':'<i class="fa-regular fa-eye-slash"></i>';

            item.appendChild(prev);
            item.appendChild(name);
            item.appendChild(icons);
            item.addEventListener("click",() => {
                state.currentLayer = Number(item.dataset.index);
                rebuildLayersUI();
            });
            layersList.appendChild(item);
        }
    }

    function renderLayers(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        state.layers.forEach(l => { if(l.visible) ctx.drawImage(l.canvas,0,0); });
    }

    function pushHistory(){
        if(state.historyIndex < state.history.length-1){
            state.history = state.history.slice(0,state.historyIndex+1);
        }
        const snapshot = state.layers.map(l => {
            const c = document.createElement("canvas");
            c.width = l.canvas.width;
            c.height = l.canvas.height;
            c.getContext("2d").drawImage(l.canvas,0,0);
            return {name:l.name,visible:l.visible,locked:l.locked,canvas:c};
        });
        state.history.push(snapshot);
        if(state.history.length>state.maxHistory) state.history.shift();
        state.historyIndex = state.history.length-1;
    }

    function restoreHistory(index){
        if(index<0 || index>=state.history.length) return;
        const snap = state.history[index];
        state.layers = snap.map(l => {
            const c=document.createElement("canvas");
            c.width=l.canvas.width;
            c.height=l.canvas.height;
            c.getContext("2d").drawImage(l.canvas,0,0);
            return {name:l.name,visible:l.visible,locked:l.locked,canvas:c};
        });
        renderLayers();
        rebuildLayersUI();
    }

    function undo(){
        if(state.historyIndex<=0) return;
        state.historyIndex--;
        restoreHistory(state.historyIndex);
    }
    function redo(){
        if(state.historyIndex>=state.history.length-1) return;
        state.historyIndex++;
        restoreHistory(state.historyIndex);
    }

    function setTool(t){
        state.tool=t;
        document.querySelectorAll(".tool").forEach(btn=>{
            btn.classList.toggle("tool--active",btn.dataset.tool===t);
        });
    }

    function updateZoom(z){
        state.zoom = Math.min(4,Math.max(.25,z));
        canvas.style.transform = `scale(${state.zoom})`;
        previewCanvas.style.transform = `scale(${state.zoom})`;
        zoomLabel.textContent = `${Math.round(state.zoom*100)}%`;
    }

    function canvasPos(e){
        const rect = canvas.getBoundingClientRect();
        return {
            x:(e.clientX-rect.left)/state.zoom,
            y:(e.clientY-rect.top)/state.zoom
        };
    }

    function currentLayerCtx(){
        return state.layers[state.currentLayer].canvas.getContext("2d",{willReadFrequently:true});
    }

    function startDraw(e){
        if(state.layers[state.currentLayer].locked) return;
        state.drawing=true;
        const {x,y}=canvasPos(e);
        state.lastX=x;state.lastY=y;
        if(state.tool==="brush") drawTo(x,y,true);
    }

    function drawMove(e){
        if(!state.drawing) return;
        const {x,y}=canvasPos(e);
        if(state.tool==="brush") drawTo(x,y,false);
        state.lastX=x;state.lastY=y;
    }

    function stopDraw(){
        if(!state.drawing) return;
        state.drawing=false;
        pCtx.clearRect(0,0,previewCanvas.width,previewCanvas.height);
        renderLayers();
        pushHistory();
    }

    function hueFromTime(){
        return (Date.now()/10)%360;
    }

    function drawTo(x,y,start){
        const lctx = currentLayerCtx();
        lctx.globalCompositeOperation = state.blend;
        lctx.globalAlpha = state.opacity;
        const color = state.rainbow ? `hsl(${hueFromTime()},100%,55%)` : state.colorPrimary;
        lctx.strokeStyle = color;
        lctx.lineWidth = state.size;
        lctx.lineCap = "round";
        lctx.lineJoin = "round";
        lctx.shadowBlur = state.rainbow?10:0;
        lctx.shadowColor = color;
        lctx.beginPath();
        if(start) lctx.moveTo(x,y);
        else lctx.moveTo(state.lastX,state.lastY);
        lctx.lineTo(x,y);
        lctx.stroke();
        renderLayers();
    }

    function initPalette(){
        const colors=[
            "#000000","#ffffff","#ef4444","#22c55e","#3b82f6","#eab308",
            "#ec4899","#06b6d4","#f97316","#a855f7","#10b981","#facc15",
            "#4b5563","#9ca3af","#0ea5e9","#fbbf24","#ef476f","#ffd166"
        ];
        colors.forEach(c=>{
            const s=document.createElement("button");
            s.className="swatch";
            s.style.background=c;
            s.addEventListener("click",()=>{
                state.colorPrimary=c;
                primaryColorInput.value=c;
                primarySwatch.style.background=c;
                document.querySelectorAll(".swatch").forEach(el=>el.classList.remove("swatch--active"));
                s.classList.add("swatch--active");
            });
            paletteEl.appendChild(s);
        });
    }

    rangeSize.addEventListener("input",()=>{
        state.size = Number(rangeSize.value);
        valSize.textContent = `${state.size} px`;
    });
    rangeOp.addEventListener("input",()=>{
        state.opacity = Number(rangeOp.value)/100;
        valOp.textContent = `${rangeOp.value}%`;
    });
    rangeHard.addEventListener("input",()=>{
        state.hardness = Number(rangeHard.value)/100;
        valHard.textContent = `${rangeHard.value}%`;
    });

    toggleRainbow.addEventListener("click",()=>{
        toggleRainbow.classList.toggle("pill-toggle--on");
        state.rainbow = toggleRainbow.classList.contains("pill-toggle--on");
        frame.classList.toggle("canvas-frame--rainbow",state.rainbow);
    });

    primarySwatch.addEventListener("click",()=>primaryColorInput.click());
    secondarySwatch.addEventListener("click",()=>secondaryColorInput.click());
    primaryColorInput.addEventListener("input",e=>{
        state.colorPrimary=e.target.value;
        primarySwatch.style.background=e.target.value;
    });
    secondaryColorInput.addEventListener("input",e=>{
        state.colorSecondary=e.target.value;
        secondarySwatch.style.background=e.target.value;
    });

    blendModeSelect.addEventListener("change",e=>{
        state.blend=e.target.value;
    });

    document.querySelectorAll(".tool").forEach(btn=>{
        btn.addEventListener("click",()=>setTool(btn.dataset.tool));
    });

    canvas.addEventListener("mousedown",startDraw);
    canvas.addEventListener("mousemove",drawMove);
    window.addEventListener("mouseup",stopDraw);
    canvas.addEventListener("mouseleave",stopDraw);

    document.getElementById("zoom-in").addEventListener("click",()=>updateZoom(state.zoom+.25));
    document.getElementById("zoom-out").addEventListener("click",()=>updateZoom(state.zoom-.25));
    document.getElementById("zoom-reset").addEventListener("click",()=>updateZoom(1));

    document.getElementById("btn-undo").addEventListener("click",undo);
    document.getElementById("btn-redo").addEventListener("click",redo);

    document.getElementById("btn-clear").addEventListener("click",()=>{
        if(!confirm("Очистить холст?"))return;
        const lctx=currentLayerCtx();
        lctx.clearRect(0,0,canvas.width,canvas.height);
        renderLayers();
        pushHistory();
    });

    document.getElementById("btn-flip-h").addEventListener("click",()=>{
        const lctx=currentLayerCtx();
        const off=state.layers[state.currentLayer].canvas;
        const tmp=document.createElement("canvas");
        tmp.width=off.width;tmp.height=off.height;
        tmp.getContext("2d").drawImage(off,0,0);
        lctx.save();
        lctx.clearRect(0,0,off.width,off.height);
        lctx.translate(off.width,0);
        lctx.scale(-1,1);
        lctx.drawImage(tmp,0,0);
        lctx.restore();
        renderLayers();
        pushHistory();
    });

    document.getElementById("btn-flip-v").addEventListener("click",()=>{
        const lctx=currentLayerCtx();
        const off=state.layers[state.currentLayer].canvas;
        const tmp=document.createElement("canvas");
        tmp.width=off.width;tmp.height=off.height;
        tmp.getContext("2d").drawImage(off,0,0);
        lctx.save();
        lctx.clearRect(0,0,off.width,off.height);
        lctx.translate(0,off.height);
        lctx.scale(1,-1);
        lctx.drawImage(tmp,0,0);
        lctx.restore();
        renderLayers();
        pushHistory();
    });

    document.getElementById("btn-rotate").addEventListener("click",()=>{
        const lctx=currentLayerCtx();
        const off=state.layers[state.currentLayer].canvas;
        const tmp=document.createElement("canvas");
        tmp.width=off.width;tmp.height=off.height;
        tmp.getContext("2d").drawImage(off,0,0);
        lctx.save();
        lctx.clearRect(0,0,off.width,off.height);
        lctx.translate(off.width/2,off.height/2);
        lctx.rotate(Math.PI/2);
        lctx.drawImage(tmp,-off.height/2,-off.width/2,off.height,off.width);
        lctx.restore();
        renderLayers();
        pushHistory();
    });

    shareBtn.addEventListener("click",e=>{
        shareMenu.classList.toggle("share-menu--open");
        const rect = shareBtn.getBoundingClientRect();
        shareRipple.style.left = `${e.clientX-rect.left-5}px`;
        shareRipple.style.top = `${e.clientY-rect.top-5}px`;
        shareRipple.style.opacity="1";
        shareRipple.style.transform="scale(0)";
        shareRipple.style.transition="none";
        requestAnimationFrame(()=>{
            shareRipple.style.transition="transform .45s ease-out,opacity .45s ease-out";
            shareRipple.style.transform="scale(4)";
            shareRipple.style.opacity="0";
        });
    });

    document.querySelectorAll(".share-icon").forEach(btn=>{
        btn.addEventListener("click",async()=>{
            const platform=btn.dataset.platform;
            const dataUrl=canvas.toDataURL("image/png");
            try{
                const blob=await (await fetch(dataUrl)).blob();
                const file=new File([blob],"multicolor-square.png",{type:"image/png"});
                const shareData={title:"MULTICOLOR SQUARE",text:"Мой арт из MULTICOLOR SQUARE",files:[file]};
                if(navigator.share && navigator.canShare && navigator.canShare(shareData)){
                    await navigator.share(shareData);
                }else{
                    openShareUrl(platform);
                }
            }catch{
                openShareUrl(platform);
            }
        });
    });

    function openShareUrl(platform){
        const base={
            telegram:"https://t.me/share/url?url=",
            vk:"https://vk.com/share.php?url=",
            pinterest:"https://pinterest.com/pin/create/button/?url=",
            whatsapp:"https://wa.me/?text=",
            twitter:"https://twitter.com/intent/tweet?text="
        }[platform];
        if(!base)return;
        const url=window.location.href;
        window.open(base+encodeURIComponent(url),"share","width=640,height=520");
    }

    const modalCanvas=document.getElementById("modal-canvas");
    const modalExport=document.getElementById("modal-export");
    const btnCanvas=document.getElementById("btn-canvas");
    const btnExport=document.getElementById("btn-export");
    const btnCanvasCancel=document.getElementById("canvas-cancel");
    const btnCanvasApply=document.getElementById("canvas-apply");
    const customW=document.getElementById("custom-w");
    const customH=document.getElementById("custom-h");
    const formatSelect=document.getElementById("export-format");
    const rangeQuality=document.getElementById("range-quality");
    const valQuality=document.getElementById("val-quality");
    const btnExportCancel=document.getElementById("export-cancel");
    const btnExportOk=document.getElementById("export-ok");

    btnCanvas.addEventListener("click",()=>modalCanvas.classList.add("modal--open"));
    btnCanvasCancel.addEventListener("click",()=>modalCanvas.classList.remove("modal--open"));
    document.querySelectorAll("#modal-canvas .modal__btn").forEach(b=>{
        b.addEventListener("click",()=>{
            customW.value=b.dataset.w;
            customH.value=b.dataset.h;
        });
    });
    btnCanvasApply.addEventListener("click",()=>{
        const w=Math.max(1,Math.min(4096,Number(customW.value)||960));
        const h=Math.max(1,Math.min(4096,Number(customH.value)||620));
        resizeCanvas(w,h);
        modalCanvas.classList.remove("modal--open");
    });

    function resizeCanvas(w,h){
        const prevLayers=state.layers.map(l=>{
            const t=document.createElement("canvas");
            t.width=l.canvas.width;
            t.height=l.canvas.height;
            t.getContext("2d").drawImage(l.canvas,0,0);
            return t;
        });
        canvas.width=w;
        canvas.height=h;
        previewCanvas.width=w;
        previewCanvas.height=h;
        state.layers.forEach((l,i)=>{
            l.canvas.width=w;
            l.canvas.height=h;
            const lctx=l.canvas.getContext("2d");
            lctx.clearRect(0,0,w,h);
            lctx.drawImage(prevLayers[i],0,0,w,h);
        });
        renderLayers();
        pushHistory();
    }

    btnExport.addEventListener("click",()=>modalExport.classList.add("modal--open"));
    btnExportCancel.addEventListener("click",()=>modalExport.classList.remove("modal--open"));
    rangeQuality.addEventListener("input",()=>{
        valQuality.textContent=`${rangeQuality.value}%`;
    });
    btnExportOk.addEventListener("click",()=>{
        const fmt=formatSelect.value;
        const quality=Number(rangeQuality.value)/100;
        let mime="image/png";
        if(fmt==="jpeg") mime="image/jpeg";
        else if(fmt==="webp") mime="image/webp";
        const url=canvas.toDataURL(mime,quality);
        const a=document.createElement("a");
        a.href=url;
        a.download=`multicolor-square.${fmt}`;
        a.click();
        modalExport.classList.remove("modal--open");
    });

    document.getElementById("btn-layers").addEventListener("click",()=>{
        layersPanel.classList.toggle("layers-panel--open");
    });
    document.getElementById("add-layer").addEventListener("click",()=>{
        addLayer(`Слой ${state.layers.length}`);
        renderLayers();
        pushHistory();
    });

    document.getElementById("btn-new").addEventListener("click",()=>{
        if(!confirm("Создать новый проект?"))return;
        state.layers.forEach(l=>l.canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height));
        ctx.fillStyle="#ffffff";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        renderLayers();
        state.history=[];state.historyIndex=-1;
        pushHistory();
    });

    document.getElementById("btn-save").addEventListener("click",()=>{
        const payload={
            w:canvas.width,
            h:canvas.height,
            layers:state.layers.map(l=>({
                name:l.name,
                visible:l.visible,
                locked:l.locked,
                data:l.canvas.toDataURL()
            }))
        };
        const blob=new Blob([JSON.stringify(payload)],{type:"application/json"});
        const a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        a.download="multicolor-square-project.json";
        a.click();
    });

    document.getElementById("btn-open").addEventListener("click",()=>{
        const input=document.createElement("input");
        input.type="file";
        input.accept=".json";
        input.onchange=e=>{
            const file=e.target.files[0];
            if(!file)return;
            const reader=new FileReader();
            reader.onload=ev=>{
                try{
                    const data=JSON.parse(ev.target.result);
                    canvas.width=data.w;canvas.height=data.h;
                    previewCanvas.width=data.w;previewCanvas.height=data.h;
                    state.layers=[];
                    let loaded=0;
                    data.layers.forEach((l,i)=>{
                        const img=new Image();
                        img.onload=()=>{
                            const off=document.createElement("canvas");
                            off.width=data.w;off.height=data.h;
                            off.getContext("2d").drawImage(img,0,0,data.w,data.h);
                            state.layers[i]={name:l.name,visible:l.visible,locked:l.locked,canvas:off};
                            loaded++;
                            if(loaded===data.layers.length){
                                state.currentLayer=0;
                                renderLayers();
                                rebuildLayersUI();
                                state.history=[];state.historyIndex=-1;
                                pushHistory();
                            }
                        };
                        img.src=l.data;
                    });
                }catch{}
            };
            reader.readAsText(file);
        };
        input.click();
    });

    document.getElementById("btn-effects").addEventListener("click",()=>alert("Эффект-центр можно дорасширить под нужные фильтры и анимации."));

    document.addEventListener("keydown",e=>{
        if((e.metaKey||e.ctrlKey)&&e.key==="z"){e.preventDefault();undo();}
        else if((e.metaKey||e.ctrlKey)&&e.key==="y"){e.preventDefault();redo();}
        else if(e.key==="b"||e.key==="B") setTool("brush");
    });

    updateZoom(1);
    initPalette();
    initBase();
})();
</script>
</body>
</html>
